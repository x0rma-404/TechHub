// Quill Editorun Yaradılması (Şəkil və Fayl dəstəyi ilə)
var quill;

function initQuill() {
    if (quill) return; // Artıq yaranıbsa yaratma

    var toolbarOptions = [
        ['bold', 'italic', 'underline'],        // Point 4b: Qalın, İtalik
        [{ 'size': ['small', false, 'large', 'huge'] }],  // Point 4b: Şrift ölçüsü
        [{ 'list': 'ordered' }, { 'list': 'bullet' }],     // Point 4b: Siyahı
        [{ 'background': [] }],                           // Point 4b: Highlighter
        ['link', 'image']                                 // Point 4b: Şəkil/Fayl
    ];

    quill = new Quill('#editor-container', {
        modules: { toolbar: toolbarOptions },
        theme: 'snow',
        placeholder: 'Sualınızı ətraflı yazın...'
    });

    // Şəkil yükləməni idarə etmək (Base64 yox, serverə yükləmək üçün)
    quill.getModule('toolbar').addHandler('image', function () {
        selectLocalImage();
    });
}

function selectLocalImage() {
    const input = document.createElement('input');
    input.setAttribute('type', 'file');
    input.setAttribute('accept', 'image/*');
    input.click();

    input.onchange = () => {
        const file = input.files[0];
        if (/^image\//.test(file.type)) {
            saveToServer(file);
        } else {
            alert('Yalnız şəkil seçə bilərsiniz.');
        }
    };
}

function saveToServer(file) {
    const fd = new FormData();
    fd.append('image', file);

    fetch('/api/upload_image', {
        method: 'POST',
        body: fd
    })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                const range = quill.getSelection();
                quill.insertEmbed(range.index, 'image', result.url);
            } else {
                alert('Şəkil yüklənə bilmədi');
            }
        })
        .catch(error => {
            console.error('Xəta:', error);
        });
}

function openQuestionModal() {
    document.getElementById('questionModal').style.display = 'block';
    initQuill(); // Modalı açanda editoru başlat
}

function closeQuestionModal() {
    document.getElementById('questionModal').style.display = 'none';
}

function submitQuestion(category) {
    const title = document.getElementById('newTitle').value;
    const content = quill.root.innerHTML; // Rich Text HTML-i alırıq
    const plainText = quill.getText().trim();

    if (!title || !plainText) return alert("Başlıq və mətn boş ola bilməz!");

    fetch('/api/new_question', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            title: title,
            content: content, // HTML formatında göndəririk
            category: category,
            tags: []
        })
    })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert("Xəta: " + data.message);
            }
        });
}

// Sorğu silmə funksiyası (Javascript hissəsi)
function deleteQuestion(event, id) {
    event.stopPropagation(); // Karta basanda detala getməsinin qarşısını al
    if (!confirm('Bu sualı silmək istədiyinizə əminsiniz?')) return;

    fetch('/api/delete_question', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: id })
    })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById('q-' + id).remove();
            } else {
                alert(data.message);
            }
        });
}

function filterTopics() {
    const term = document.getElementById('searchInput').value.toLowerCase();
    const items = document.querySelectorAll('.q-list-item');
    items.forEach(item => {
        const title = item.querySelector('h3').textContent.toLowerCase();
        item.style.display = title.includes(term) ? 'flex' : 'none';
    });
}
