{% extends "bar.html" %}

{% block content %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<link rel="stylesheet" href="/static/Q&A.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<div class="wrapper">
    <main class="content-area">
        <div class="header-section">
            <button onclick="history.back()" class="cat-btn" style="width: fit-content;">
                <i class="fas fa-arrow-left"></i> Geriyə
            </button>
        </div>

        <div class="main-post-card"
            style="background: var(--card-bg); padding: 25px; border-radius: 10px; box-shadow: var(--shadow); margin-bottom: 30px;">
            <div class="q-user-meta" style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <img class="comment-avatar"
                    src="{{ question.author_photo.replace('../', '/') if question.author_photo else 'https://ui-avatars.com/api/?background=random&color=fff&name=' + (question.author_name | urlencode) }}"
                    alt="avatar"
                    onerror="this.onerror=null;this.src='https://ui-avatars.com/api/?background=random&color=fff&name={{ question.author_name | urlencode }}';"
                    style="width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 1px solid #ddd;">
                <div>
                    <strong style="font-size: 1.1em;">{{ question.author_name }}</strong>
                    <div style="font-size: 0.85em; color: var(--text-sub);">{{ question.timestamp | format_time }}</div>
                </div>

                <button class="cat-btn" style="margin-left: auto; font-size: 0.8rem; padding: 5px 15px;"
                    onclick="setReply(null, '{{ question.author_name }}', 'main')">
                    <i class="fas fa-reply"></i> Cavabla
                </button>
            </div>

            <h1 style="margin: 10px 0; font-size: 1.8rem; color: var(--text-main);">{{ question.title }}</h1>

            <div class="post-body ql-editor" style="padding: 0; min-height: auto;">
                {{ question.content | safe }}
            </div>

            <div class="q-tags" style="margin-top: 20px;">
                <span class="tag">{{ question.category|upper }}</span>
                {% for tag in question.tags %}
                <span class="tag">{{ tag }}</span>
                {% endfor %}
            </div>
        </div>

        <h3 style="margin-bottom: 20px;">{{ question.answers|length }} Cavab</h3>
        <div class="answers-list">
    {% for ans in question.answers %}
    <div class="comment-card" id="ans-{{ ans.id }}"
        style="padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--accent); position: relative;">

        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="display: flex; gap: 10px;">
                <img class="comment-avatar"
                    src="{{ ans.author_photo.replace('../', '/') if ans.author_photo else 'https://ui-avatars.com/api/?background=random&color=fff&name=' + (ans.author_name | urlencode) }}"
                    alt="avatar"
                    onerror="this.onerror=null;this.src='https://ui-avatars.com/api/?background=random&color=fff&name={{ ans.author_name | urlencode }}';"
                    style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #ddd;">
                
                <div>
                    <strong>{{ ans.author_name }}</strong>
                    
                    <span class="user-role-badge role-{{ ans.role | lower | replace('ə', 'e') | replace('ç', 'c') | replace('ş', 's') | replace('ü', 'u') | replace('ö', 'o') | replace('ı', 'i') }}">
                        {{ ans.role }}
                    </span>
                    
                    <div style="font-size: 0.8rem; color: #888;">{{ ans.timestamp | format_time }}</div>
                </div>
            </div>

            <div style="display: flex; align-items: center;">
                <button
                    style="border:none; background:none; color:var(--accent); cursor:pointer; margin-right: 10px;"
                    onclick="setReply('{{ ans.id }}', '{{ ans.author_name }}', 'sub')">
                    <i class="fas fa-reply"></i>
                </button>

                {% if user.email == ans.author_email or user.role in ['Administrator', 'Moderator', 'Staff'] %}
                <button class="delete-btn" onclick="deleteAnswer('{{ question.id }}', '{{ ans.id }}')">
                    <i class="fas fa-trash"></i>
                </button>
                {% endif %}
            </div>
        </div>

        {% if ans.reply_to %}
        <div class="reply-indicator"
            style="margin-top: 10px; font-size: 0.9em; background: var(--input-bg); padding: 5px 10px; border-radius: 5px;">
            <i class="fas fa-share" style="margin-right: 5px;"></i>
            Cavab verilir: <strong>{{ ans.reply_to.name }}</strong>
        </div>
        {% endif %}

        <div class="comment-content ql-editor" style="padding: 10px 0; min-height: auto;">
            {{ ans.text | safe }}
        </div>


    </div>
    {% endfor %}
</div>

        <div class="reply-section" style="margin-top: 40px; padding: 20px; border-radius: 10px;">
            <h3>Cavab yaz</h3>

            <div id="reply-tag-area" style="display: none; margin-bottom: 10px;">
                <span class="reply-badge">
                    <span id="reply-target-name">Sualın özünə cavab</span>
                    <i class="fas fa-times" onclick="cancelReply()"></i>
                </span>
            </div>

            <div id="editor-container" style="height: 150px; margin-bottom: 50px;"></div>

            <div style="text-align: right; margin-top: 10px;">
                <button class="cat-btn active" onclick="submitAnswer('{{ question.id }}')">
                    <i class="fas fa-paper-plane"></i> Göndər
                </button>
            </div>
        </div>
    </main>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    var quill;
    // Default olaraq əsas suala cavab veririk
    let replyContext = { id: null, name: '{{ question.author_name }}' };

    document.addEventListener('DOMContentLoaded', function () {
        // Point 4: Şrift ölçüsü (size) əlavə olundu
        var toolbarOptions = [
            [{ 'size': ['small', false, 'large', 'huge'] }], // Şrift ölçüləri
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            [{ 'color': [] }, { 'background': [] }],
            ['link', 'image', 'code-block']
        ];

        quill = new Quill('#editor-container', {
            modules: { toolbar: toolbarOptions },
            theme: 'snow',
            placeholder: 'Cavabınızı bura yazın...'
        });

        // Point 3: Səhifə açılan kimi default "Suala cavab verilir" göstər
        updateReplyBadge();

        // Şəkil yükləmə handler
        quill.getModule('toolbar').addHandler('image', selectLocalImage);
    });

    // Vizual göstərici funksiyası
    function updateReplyBadge() {
        const tagArea = document.getElementById('reply-tag-area');
        const nameSpan = document.getElementById('reply-target-name');

        tagArea.style.display = 'block'; // Həmişə görünür

        if (replyContext.id === null) {
            // Əsas sual
            nameSpan.innerHTML = `Sualın özünə cavab verilir: <strong>${replyContext.name}</strong>`;
            // Ləğv et düyməsini gizlədə bilərik, çünki bu default haldır
            document.querySelector('.fa-times').style.display = 'none';
        } else {
            // Konkret şəxs
            nameSpan.innerHTML = `Cavab verilir: <strong>${replyContext.name}</strong>`;
            document.querySelector('.fa-times').style.display = 'inline-block';
        }
    }

    function setReply(id, name, type) {
        // Editora sürüşdür
        document.querySelector('.reply-section').scrollIntoView({ behavior: 'smooth' });
        quill.focus();

        if (type === 'main') {
            cancelReply();
            return;
        }

        replyContext = { id: id, name: name };
        updateReplyBadge();
    }

    function cancelReply() {
        // Sıfırla (Main suala qayıt)
        replyContext = { id: null, name: '{{ question.author_name }}' };
        updateReplyBadge();
    }

    // Göndərmə funksiyası
    function submitAnswer(questionId) {
        const content = quill.root.innerHTML;
        const plainText = quill.getText().trim();

        if (!plainText && !content.includes('<img')) {
            alert("Boş cavab göndərmək olmaz!");
            return;
        }

        fetch('/api/add_answer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                question_id: questionId,
                text: content,
                reply_to: replyContext.id ? replyContext : null // Backend məntiqinə uyğun
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) location.reload();
                else alert("Xəta baş verdi.");
            });
    }

    // Şəkil funksiyaları olduğu kimi qalır...
    function selectLocalImage() {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');
        input.click();
        input.onchange = () => {
            const file = input.files[0];
            if (/^image\//.test(file.type)) saveToServer(file);
        };
    }

    function saveToServer(file) {
        const fd = new FormData();
        fd.append('image', file);
        fetch('/api/upload_image', { method: 'POST', body: fd })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const range = quill.getSelection();
                    quill.insertEmbed(range.index, 'image', data.url);
                }
            });
    }

    // Silmə funksiyası (olduğu kimi)
    function deleteAnswer(qId, ansId) {
        if (!confirm("Silmək istəyirsiniz?")) return;
        fetch('/api/delete_answer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question_id: qId, answer_id: ansId })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) document.getElementById('ans-' + ansId).remove();
            });
    }
</script>

{% endblock %}