{% extends "bar.html" %}

{% block content %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<link rel="stylesheet" href="/static/Q&A.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<div class="wrapper animate-stagger">
    <main class="content-area">
        <div class="header-section">
            <button onclick="history.back()" class="cat-btn">
                <i class="fas fa-arrow-left"></i> Geriyə
            </button>
        </div>

        <article class="main-post-card group">
            <div class="q-user-meta mb-6">
                <img class="comment-avatar border-2 border-slate-700 shadow-xl"
                    src="{{ question.author_photo.replace('../', '/') if question.author_photo else 'https://ui-avatars.com/api/?background=random&color=fff&name=' + (question.author_name | urlencode) }}"
                    alt="avatar"
                    onerror="this.onerror=null;this.src='https://ui-avatars.com/api/?background=random&color=fff&name={{ question.author_name | urlencode }}';">
                <div class="flex-1">
                    <strong class="text-slate-100 text-lg block leading-tight">{{ question.author_name }}</strong>
                    <div class="text-sm text-slate-500">{{ question.timestamp | format_time }}</div>
                </div>

                <button class="cat-btn !text-xs !py-1 !px-3"
                    onclick="setReply(null, '{{ question.author_name }}', 'main')">
                    <i class="fas fa-reply mr-1"></i> Cavabla
                </button>
            </div>

            <h1 class="text-3xl font-extrabold text-slate-100 mb-6 leading-tight tracking-tight">{{ question.title }}
            </h1>

            <div class="post-body ql-editor !p-0 !min-h-0 text-lg leading-relaxed text-slate-300">
                {{ question.content | safe }}
            </div>

            <div class="q-tags mt-8 border-t border-slate-800 pt-6">
                <span
                    class="tag active bg-indigo-500/10 text-indigo-400 border border-indigo-500/20 uppercase tracking-wider text-[10px] font-bold">{{
                    question.category }}</span>
                {% for tag in question.tags %}
                <span class="tag uppercase tracking-wider text-[10px] font-bold">{{ tag }}</span>
                {% endfor %}
            </div>
        </article>

        <h3 class="text-xl font-bold text-slate-100 mb-6 flex items-center gap-2">
            <i class="fas fa-comments text-indigo-400"></i>
            {{ question.answers|length }} Cavab
        </h3>

        <div class="answers-list space-y-6">
            {% for ans in question.answers %}
            <div class="comment-card" id="ans-{{ ans.id }}">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex gap-3 items-center">
                        <img class="comment-avatar border border-slate-700"
                            src="{{ ans.author_photo.replace('../', '/') if ans.author_photo else 'https://ui-avatars.com/api/?background=random&color=fff&name=' + (ans.author_name | urlencode) }}"
                            alt="avatar"
                            onerror="this.onerror=null;this.src='https://ui-avatars.com/api/?background=random&color=fff&name={{ ans.author_name | urlencode }}';">
                        <div>
                            <strong class="text-slate-200">{{ ans.author_name }}</strong>
                            <span class="user-role-badge !ml-2 {% if ans.role == 'AI Assistant' %}role-ai{% endif %}">{{
                                ans.role }}</span>
                            <div class="text-xs text-slate-500 mt-1">{{ ans.timestamp | format_time }}</div>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <button class="cat-btn !p-2 !rounded-lg !bg-transparent !border-transparent hover:!bg-slate-800"
                            onclick="setReply('{{ ans.id }}', '{{ ans.author_name }}', 'sub')" title="Cavabla">
                            <i class="fas fa-reply"></i>
                        </button>

                        {% if user.email == ans.author_email or user.role in ['Administrator', 'Moderator', 'Staff'] %}
                        <button class="delete-btn !m-0 !p-2 rounded-lg hover:bg-red-500/10"
                            onclick="deleteAnswer('{{ question.id }}', '{{ ans.id }}')" title="Sil">
                            <i class="fas fa-trash"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>

                {% if ans.reply_to %}
                <div class="reply-indicator">
                    <i class="fas fa-share-alt mr-2"></i>
                    Cavab verilir: <span class="text-slate-300 font-semibold">{{ ans.reply_to.name }}</span>
                </div>
                {% endif %}

                <div class="comment-content ql-editor !p-0 !min-h-0 text-slate-300">
                    {{ ans.text | safe }}
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="reply-section mt-12 glass-panel !p-8 ring-premium">
            <h3 class="text-xl font-bold text-slate-100 mb-6">Fikrini bildir</h3>

            <div id="reply-tag-area" class="hidden mb-4">
                <span
                    class="reply-badge bg-indigo-500/10 text-indigo-400 border border-indigo-500/20 px-4 py-2 rounded-xl text-sm inline-flex items-center gap-2">
                    <span id="reply-target-name">Sualın özünə cavab</span>
                    <i class="fas fa-times cursor-pointer hover:text-red-400" onclick="cancelReply()"></i>
                </span>
            </div>

            <div id="editor-container" class="!bg-slate-900 !border-slate-800 rounded-xl"
                style="height: 180px; margin-bottom: 50px;"></div>

            <div class="flex justify-end pt-4">
                <button class="cat-btn active !px-8 !py-3 !rounded-xl text-lg"
                    onclick="submitAnswer('{{ question.id }}')">
                    <i class="fas fa-paper-plane mr-2"></i> Göndər
                </button>
            </div>
        </div>
    </main>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    var quill;
    // Default olaraq əsas suala cavab veririk
    let replyContext = { id: null, name: '{{ question.author_name }}' };

    document.addEventListener('DOMContentLoaded', function () {
        // Point 4: Şrift ölçüsü (size) əlavə olundu
        var toolbarOptions = [
            [{ 'size': ['small', false, 'large', 'huge'] }], // Şrift ölçüləri
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            [{ 'color': [] }, { 'background': [] }],
            ['link', 'image', 'code-block']
        ];

        quill = new Quill('#editor-container', {
            modules: { toolbar: toolbarOptions },
            theme: 'snow',
            placeholder: 'Cavabınızı bura yazın...'
        });

        // Point 3: Səhifə açılan kimi default "Suala cavab verilir" göstər
        updateReplyBadge();

        // Şəkil yükləmə handler
        quill.getModule('toolbar').addHandler('image', selectLocalImage);
    });

    // Vizual göstərici funksiyası
    function updateReplyBadge() {
        const tagArea = document.getElementById('reply-tag-area');
        const nameSpan = document.getElementById('reply-target-name');

        tagArea.style.display = 'block'; // Həmişə görünür

        if (replyContext.id === null) {
            // Əsas sual
            nameSpan.innerHTML = `Sualın özünə cavab verilir: <strong>${replyContext.name}</strong>`;
            // Ləğv et düyməsini gizlədə bilərik, çünki bu default haldır
            document.querySelector('.fa-times').style.display = 'none';
        } else {
            // Konkret şəxs
            nameSpan.innerHTML = `Cavab verilir: <strong>${replyContext.name}</strong>`;
            document.querySelector('.fa-times').style.display = 'inline-block';
        }
    }

    function setReply(id, name, type) {
        // Editora sürüşdür
        document.querySelector('.reply-section').scrollIntoView({ behavior: 'smooth' });
        quill.focus();

        if (type === 'main') {
            cancelReply();
            return;
        }

        replyContext = { id: id, name: name };
        updateReplyBadge();
    }

    function cancelReply() {
        // Sıfırla (Main suala qayıt)
        replyContext = { id: null, name: '{{ question.author_name }}' };
        updateReplyBadge();
    }

    // Göndərmə funksiyası
    function submitAnswer(questionId) {
        const content = quill.root.innerHTML;
        const plainText = quill.getText().trim();

        if (!plainText && !content.includes('<img')) {
            alert("Boş cavab göndərmək olmaz!");
            return;
        }

        fetch('/api/add_answer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                question_id: questionId,
                text: content,
                reply_to: replyContext.id ? replyContext : null // Backend məntiqinə uyğun
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) location.reload();
                else alert("Xəta baş verdi.");
            });
    }

    // Şəkil funksiyaları olduğu kimi qalır...
    function selectLocalImage() {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');
        input.click();
        input.onchange = () => {
            const file = input.files[0];
            if (/^image\//.test(file.type)) saveToServer(file);
        };
    }

    function saveToServer(file) {
        const fd = new FormData();
        fd.append('image', file);
        fetch('/api/upload_image', { method: 'POST', body: fd })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const range = quill.getSelection();
                    quill.insertEmbed(range.index, 'image', data.url);
                }
            });
    }

    // Silmə funksiyası (olduğu kimi)
    function deleteAnswer(qId, ansId) {
        if (!confirm("Silmək istəyirsiniz?")) return;
        fetch('/api/delete_answer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question_id: qId, answer_id: ansId })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) document.getElementById('ans-' + ansId).remove();
            });
    }

    // AI Markdown Parsing & Highlighting
    document.addEventListener('DOMContentLoaded', function () {
        // Find all AI answers
        const aiBadges = document.querySelectorAll('.role-ai');
        aiBadges.forEach(badge => {
            const commentCard = badge.closest('.comment-card');
            if (commentCard) {
                const contentDiv = commentCard.querySelector('.comment-content');
                if (contentDiv) {
                    // Get raw text (Markdown)
                    const rawMarkdown = contentDiv.textContent.trim();
                    // Parse and set as HTML
                    contentDiv.innerHTML = marked.parse(rawMarkdown);
                }
            }
        });

        // Trigger syntax highlighting for all code blocks
        hljs.highlightAll();
    });
</script>

{% endblock %}