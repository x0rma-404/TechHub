{% extends "bar.html" %}

{% block header_class %}relative{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='profile.css') }}">

<div class="max-w-5xl mx-auto px-4 py-8">
  <div id="viewMode" class="glass ring-soft rounded-2xl overflow-hidden">
    <div class="h-48 bg-gradient-to-r from-indigo-600/40 to-cyan-600/40 relative">
      {% if user.banner %}
      <img src="{{ user.banner }}" alt="Banner" class="w-full h-full object-cover">
      {% endif %}
    </div>

    <div class="p-6 md:p-8">
      <div class="flex flex-col md:flex-row gap-6 items-start -mt-20 md:-mt-16">
        <img src="{{ user.photo or url_for('static', filename='images/default.png') }}" alt="Avatar"
          class="h-32 w-32 rounded-2xl border-4 border-[#0b1220] object-cover">

        <div class="flex-1">
          <h2 class="text-2xl font-bold mb-1">{{ user.name }}</h2>
          <p class="text-slate-400 mb-4">@{{ user.name }} â€¢ {{ user.email }}</p>

          <div class="flex flex-wrap gap-4 text-sm text-slate-400 mb-4">
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-lg">home</span>
              {{ user.location if user.location else 'Location unset' }}
            </div>
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-lg">calendar_today</span>
              <span id="joinDateDisplay"></span>
            </div>
          </div>

          {% if user.role %}
          <span class="badge">{{ user.role }}</span>
          {% endif %}
        </div>

        <button id="toEditBtn" class="btn btn-primary">
          <span class="material-symbols-outlined">edit</span>
          Profili RedaktÉ™ Et
        </button>
      </div>

      {% if user.about %}
      <div class="mt-6 glass ring-soft rounded-xl p-4">
        <h3 class="font-semibold mb-2">HaqqÄ±nda</h3>
        <p class="text-slate-300">{{ user.about }}</p>
      </div>
      {% endif %}

      {% if user.phone or user.website %}
      <div class="mt-6 glass ring-soft rounded-xl p-4">
        <h3 class="font-semibold mb-3">ÆlaqÉ™ MÉ™lumatlarÄ±</h3>
        <div class="space-y-2 text-sm">
          {% if user.phone %}
          <div class="flex items-center gap-2 text-slate-300">
            <span class="material-symbols-outlined text-lg text-indigo-400">phone</span>
            {{ user.phone }}
          </div>
          {% endif %}
          {% if user.website %}
          <div class="flex items-center gap-2">
            <span class="material-symbols-outlined text-lg text-indigo-400">language</span>
            <a href="{{ user.website }}" target="_blank"
              class="text-indigo-400 hover:text-indigo-300 transition-colors">{{ user.website }}</a>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      {% if user.github or user.linkedin or user.twitter or user.instagram %}
      <div class="mt-6 glass ring-soft rounded-xl p-4">
        <h3 class="font-semibold mb-3">Sosial Media</h3>
        <div class="flex flex-wrap gap-3">
          {% if user.github %}
          <a href="https://github.com/{{ user.github }}" target="_blank"
            class="flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 rounded-xl transition-colors">
            <i class='bx bxl-github text-xl'></i>
            <span>{{ user.github }}</span>
          </a>
          {% endif %}
          {% if user.linkedin %}
          <a href="https://linkedin.com/in/{{ user.linkedin }}" target="_blank"
            class="flex items-center gap-2 px-4 py-2 bg-blue-500/10 hover:bg-blue-500/20 rounded-xl transition-colors">
            <i class='bx bxl-linkedin text-xl text-blue-400'></i>
            <span>{{ user.linkedin }}</span>
          </a>
          {% endif %}
          {% if user.twitter %}
          <a href="https://twitter.com/{{ user.twitter.lstrip('@') }}" target="_blank"
            class="flex items-center gap-2 px-4 py-2 bg-sky-500/10 hover:bg-sky-500/20 rounded-xl transition-colors">
            <i class='bx bxl-twitter text-xl text-sky-400'></i>
            <span>{{ user.twitter }}</span>
          </a>
          {% endif %}
          {% if user.instagram %}
          <a href="https://instagram.com/{{ user.instagram.lstrip('@') }}" target="_blank"
            class="flex items-center gap-2 px-4 py-2 bg-pink-500/10 hover:bg-pink-500/20 rounded-xl transition-colors">
            <i class='bx bxl-instagram text-xl text-pink-400'></i>
            <span>{{ user.instagram }}</span>
          </a>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <div id="editMode" class="glass ring-soft rounded-2xl overflow-hidden hidden">
    <div class="bg-gradient-to-r from-indigo-600/20 to-cyan-600/20 p-6 border-b border-white/10">
      <div class="flex items-center gap-3">
        <div class="h-12 w-12 rounded-xl bg-indigo-500/20 grid place-items-center">
          <span class="material-symbols-outlined text-indigo-400">edit</span>
        </div>
        <div>
          <h3 class="text-xl font-bold">Profil MÉ™lumatlarÄ±nÄ± YenilÉ™</h3>
          <p class="text-sm text-slate-400">ÅÉ™xsi mÉ™lumatlarÄ±nÄ±zÄ± vÉ™ sosial hesablarÄ±nÄ±zÄ± yenilÉ™yin</p>
        </div>
      </div>
    </div>

    <form id="profileForm" class="p-6 md:p-8 space-y-8">
      <!-- Photos Section -->
      <div class="space-y-4">
        <div class="flex items-center gap-2 mb-4">
          <span class="material-symbols-outlined text-indigo-400">photo_camera</span>
          <h4 class="font-semibold">ÅÉ™killÉ™r</h4>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <label class="block text-sm font-medium text-slate-300">Profil ÅÉ™kli</label>
            <input type="file" id="profile_photo_input" name="profile_photo" accept="image/*"
              class="input w-full rounded-xl px-4 py-3 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-indigo-500/20 file:text-indigo-400 file:cursor-pointer hover:file:bg-indigo-500/30">
            <p class="text-xs text-slate-500">TÃ¶vsiyÉ™ olunan: 400x400px, max 2MB</p>
          </div>
          <div class="space-y-2">
            <label class="block text-sm font-medium text-slate-300">Banner ÅÉ™kli</label>
            <input type="file" id="banner_photo_input" name="banner_photo" accept="image/*"
              class="input w-full rounded-xl px-4 py-3 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-cyan-500/20 file:text-cyan-400 file:cursor-pointer hover:file:bg-cyan-500/30">
            <p class="text-xs text-slate-500">TÃ¶vsiyÉ™ olunan: 1200x300px, max 5MB</p>
          </div>
        </div>
      </div>

      <!-- Basic Info Section -->
      <div class="space-y-4 pt-6 border-t border-white/10">
        <div class="flex items-center gap-2 mb-4">
          <span class="material-symbols-outlined text-indigo-400">person</span>
          <h4 class="font-semibold">Æsas MÉ™lumatlar</h4>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">Lokasiya</label>
          <div class="relative">
            <span
              class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">location_on</span>
            <input type="text" name="location" value="{{ user.location if user.location else '' }}"
              placeholder="MÉ™s: BakÄ±, AzÉ™rbaycan" class="input w-full rounded-xl pl-12 pr-4 py-3">
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">HaqqÄ±nda</label>
          <textarea name="about" class="input w-full rounded-xl px-4 py-3 min-h-[120px] resize-none"
            placeholder="Ã–zÃ¼nÃ¼z, bacarÄ±qlarÄ±nÄ±z vÉ™ maraqlarÄ±nÄ±z haqqÄ±nda mÉ™lumat">{{ user.about if user.about else '' }}</textarea>
          <p class="text-xs text-slate-500 mt-1">Ã–zÃ¼nÃ¼z haqqÄ±nda qÄ±sa mÉ™lumat yazÄ±n</p>
        </div>
      </div>

      <!-- Contact Section -->
      <div class="space-y-4 pt-6 border-t border-white/10">
        <div class="flex items-center gap-2 mb-4">
          <span class="material-symbols-outlined text-indigo-400">contact_phone</span>
          <h4 class="font-semibold">ÆlaqÉ™ MÉ™lumatlarÄ±</h4>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">Telefon</label>
            <div class="relative">
              <span
                class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">phone</span>
              <input type="text" name="phone" value="{{ user.phone if user.phone else '' }}"
                placeholder="+994 XX XXX XX XX" class="input w-full rounded-xl pl-12 pr-4 py-3">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">Vebsayt</label>
            <div class="relative">
              <span
                class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">language</span>
              <input type="url" name="website" value="{{ user.website if user.website else '' }}"
                placeholder="https://example.com" class="input w-full rounded-xl pl-12 pr-4 py-3">
            </div>
          </div>
        </div>
      </div>

      <!-- Social Media Section -->
      <div class="space-y-4 pt-6 border-t border-white/10">
        <div class="flex items-center gap-2 mb-4">
          <span class="material-symbols-outlined text-indigo-400">share</span>
          <h4 class="font-semibold">Sosial Media HesablarÄ±</h4>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">
              <i class='bx bxl-github'></i> GitHub
            </label>
            <div class="relative">
              <i class='bx bxl-github absolute left-4 top-1/2 -translate-y-1/2 text-slate-500'></i>
              <input type="text" name="github" value="{{ user.github if user.github else '' }}" placeholder="username"
                class="input w-full rounded-xl pl-12 pr-4 py-3">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">
              <i class='bx bxl-linkedin'></i> LinkedIn
            </label>
            <div class="relative">
              <i class='bx bxl-linkedin absolute left-4 top-1/2 -translate-y-1/2 text-blue-400'></i>
              <input type="text" name="linkedin" value="{{ user.linkedin if user.linkedin else '' }}"
                placeholder="username" class="input w-full rounded-xl pl-12 pr-4 py-3">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">
              <i class='bx bxl-twitter'></i> Twitter / X
            </label>
            <div class="relative">
              <i class='bx bxl-twitter absolute left-4 top-1/2 -translate-y-1/2 text-sky-400'></i>
              <input type="text" name="twitter" value="{{ user.twitter if user.twitter else '' }}"
                placeholder="@username" class="input w-full rounded-xl pl-12 pr-4 py-3">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">
              <i class='bx bxl-instagram'></i> Instagram
            </label>
            <div class="relative">
              <i class='bx bxl-instagram absolute left-4 top-1/2 -translate-y-1/2 text-pink-400'></i>
              <input type="text" name="instagram" value="{{ user.instagram if user.instagram else '' }}"
                placeholder="@username" class="input w-full rounded-xl pl-12 pr-4 py-3">
            </div>
          </div>
        </div>
        <p class="text-xs text-slate-500">YalnÄ±z istifadÉ™Ã§i adÄ±nÄ±zÄ± daxil edin (@ simvolu olmadan)</p>
      </div>

      <!-- Security Section -->
      <div class="space-y-4 pt-6 border-t border-white/10">
        <div class="flex items-center gap-2 mb-4">
          <span class="material-symbols-outlined text-amber-400">lock</span>
          <h4 class="font-semibold">TÉ™hlÃ¼kÉ™sizlik</h4>
        </div>
        <p class="text-sm text-slate-400 mb-4">ÅifrÉ™nizi dÉ™yiÅŸmÉ™k istÉ™yirsinizsÉ™ aÅŸaÄŸÄ±dakÄ± sahÉ™lÉ™ri doldurun</p>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">KÃ¶hnÉ™ ÅifrÉ™</label>
            <input type="password" name="old_password" placeholder="Cari ÅŸifrÉ™nizi daxil edin"
              class="input w-full rounded-xl px-4 py-3">
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Yeni ÅifrÉ™</label>
              <input type="password" name="new_password" placeholder="Yeni ÅŸifrÉ™"
                class="input w-full rounded-xl px-4 py-3">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Yeni ÅifrÉ™ni TÉ™sdiqlÉ™</label>
              <input type="password" name="confirm_password" placeholder="Yeni ÅŸifrÉ™ni tÉ™krar daxil edin"
                class="input w-full rounded-xl px-4 py-3">
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex flex-col-reverse md:flex-row gap-3 pt-6 border-t border-white/10">
        <button type="button" id="cancelEditBtn" class="btn btn-muted flex-1 justify-center">
          <span class="material-symbols-outlined">close</span>
          LÉ™ÄŸv Et
        </button>
        <button type="submit" class="btn btn-primary flex-1 justify-center shadow-lg shadow-indigo-500/20">
          <span class="material-symbols-outlined">save</span>
          YaddaÅŸda Saxla
        </button>
      </div>
    </form>
  </div>
</div>

<!-- GitHub Integration Section (Profile sayfanÄ±za ekleyin) -->
<div class="glass ring-soft p-6 rounded-2xl mb-6">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-2xl font-bold text-white flex items-center gap-2">
      <i class='bx bxl-github text-white'></i>
      GitHub Entegrasyonu
    </h2>
    <a href="/github/settings"
      class="bg-gradient-to-r from-gray-700 to-gray-900 hover:opacity-90 text-white px-4 py-2 rounded-lg transition">
      <i class='bx bx-cog mr-2'></i>Ayarlar
    </a>
  </div>

  {% if user.github_username %}
  <div class="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-4">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-emerald-500/20 flex items-center justify-center">
        <i class='bx bx-check-circle text-emerald-400 text-2xl'></i>
      </div>
      <div>
        <p class="font-semibold text-white">GitHub BaÄŸlÄ±</p>
        <p class="text-sm text-emerald-300">@{{ user.github_username }}</p>
      </div>
    </div>
  </div>
  {% else %}
  <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4">
    <p class="text-blue-300 text-sm mb-3">
      <i class='bx bx-info-circle mr-2'></i>
      GitHub hesabÄ±nÄ±zÄ± baÄŸlayarak projelerinizi otomatik senkronize edebilirsiniz
    </p>
    <a href="/github/settings"
      class="bg-gradient-to-r from-indigo-500 to-cyan-500 hover:opacity-90 text-white px-4 py-2 rounded-lg inline-flex items-center gap-2 transition">
      <i class='bx bx-link'></i>
      GitHub'Ä± BaÄŸla
    </a>
  </div>
  {% endif %}
</div>

<!-- Projects Section (Profile sayfanÄ±zdaki mevcut projeler bÃ¶lÃ¼mÃ¼nÃ¼ gÃ¼ncelleyin) -->
<div class="glass ring-soft p-6 rounded-2xl">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-bold text-white flex items-center gap-2">
      <i class='bx bx-folder text-indigo-400'></i>
      Projelerim
    </h2>
    <button onclick="showPushModal()"
      class="bg-gradient-to-r from-purple-500 to-blue-500 hover:opacity-90 text-white px-4 py-2 rounded-lg transition">
      <i class='bx bx-plus mr-2'></i>Yeni Proje
    </button>
  </div>

  {% if projects %}
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    {% for project in projects %}
    <div class="bg-white/5 border border-white/10 rounded-xl p-4 hover:border-white/20 transition">
      <div class="flex justify-between items-start mb-3">
        <h3 class="font-bold text-white">{{ project.title }}</h3>
        {% if project.synced %}
        <span class="badge-success text-xs">âœ“ Synced</span>
        {% endif %}
      </div>

      <p class="text-slate-400 text-sm mb-3">{{ project.description }}</p>

      <div class="flex gap-2 mb-3">
        <span class="badge-primary text-xs">{{ project.tech_stack }}</span>
        {% if project.stars %}
        <span class="badge-secondary text-xs">â­ {{ project.stars }}</span>
        {% endif %}
      </div>

      <div class="flex gap-2">
        {% if project.github_url %}
        <button onclick="syncProject('{{ project.id }}')"
          class="flex-1 bg-blue-500/20 hover:bg-blue-500/30 text-blue-300 px-3 py-2 rounded-lg text-sm transition border border-blue-500/30">
          <i class='bx bx-refresh mr-1'></i>Sync
        </button>
        <a href="{{ project.github_url }}" target="_blank"
          class="bg-white/5 hover:bg-white/10 text-white px-3 py-2 rounded-lg transition border border-white/10">
          <i class='bx bxl-github'></i>
        </a>
        {% else %}
        <button onclick="pushProjectToGithub('{{ project.id }}', '{{ project.title }}')"
          class="flex-1 bg-gradient-to-r from-purple-500 to-blue-500 hover:opacity-90 text-white px-3 py-2 rounded-lg text-sm transition">
          <i class='bx bx-upload mr-1'></i>GitHub'a YÃ¼kle
        </button>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="text-center py-12">
    <i class='bx bx-folder-open text-6xl text-slate-600'></i>
    <p class="text-slate-400 mt-3">HenÃ¼z proje yok</p>
    <a href="/github/settings"
      class="mt-4 inline-block bg-gradient-to-r from-indigo-500 to-cyan-500 hover:opacity-90 text-white px-6 py-2 rounded-lg transition">
      GitHub'dan Ä°Ã§e Aktar
    </a>
  </div>
  {% endif %}
</div>

<script>
  // Sync project from GitHub
  async function syncProject(projectId) {
    if (!confirm('ğŸ”„ Projeyi GitHub\'dan gÃ¼ncellemek istiyor musunuz?')) return;

    try {
      const response = await fetch(`/api/github/sync/${projectId}`, {
        method: 'POST'
      });

      const data = await response.json();

      if (data.success) {
        alert('âœ… ' + data.message);
        location.reload();
      } else {
        alert('âŒ ' + data.message);
      }
    } catch (error) {
      alert('âŒ Hata: ' + error);
    }
  }

  // Push project to GitHub
  async function pushProjectToGithub(projectId, projectTitle) {
    const repoName = prompt(`ğŸ“¤ Repo adÄ±:`, projectTitle.toLowerCase().replace(/\s+/g, '-'));
    if (!repoName) return;

    const description = prompt('ğŸ“ AÃ§Ä±klama (opsiyonel):') || '';
    const isPrivate = confirm('ğŸ”’ Private repo olsun mu?\n\nEvet = Private\nHayÄ±r = Public');

    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<i class="bx bx-loader-alt bx-spin mr-1"></i>YÃ¼kleniyor...';

    try {
      const response = await fetch('/api/github/push', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          project_id: projectId,
          repo_name: repoName,
          is_private: isPrivate
        })
      });

      const data = await response.json();

      if (data.success) {
        alert('âœ… ' + data.message);
        window.open(data.repo_url, '_blank');
        location.reload();
      } else {
        alert('âŒ ' + data.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="bx bx-upload mr-1"></i>GitHub\'a YÃ¼kle';
      }
    } catch (error) {
      alert('âŒ Hata: ' + error);
      btn.disabled = false;
      btn.innerHTML = '<i class="bx bx-upload mr-1"></i>GitHub\'a YÃ¼kle';
    }
  }
</script>

<script>
  const rawDate = "{{ user.createdAt }}";
  if (rawDate) {
    document.getElementById("joinDateDisplay").innerText = new Date(parseInt(rawDate)).toLocaleDateString();
  }

  const viewMode = document.getElementById('viewMode');
  const editMode = document.getElementById('editMode');
  const form = document.getElementById('profileForm');

  document.getElementById('toEditBtn').addEventListener('click', () => {
    viewMode.classList.add('hidden');
    editMode.classList.remove('hidden');
    editMode.classList.add('profile-animate-in');
  });

  document.getElementById('cancelEditBtn').addEventListener('click', () => {
    editMode.classList.remove('profile-animate-in');
    editMode.classList.add('hidden');
    viewMode.classList.remove('hidden');
    form.reset();
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);

    try {
      const response = await fetch('/update_profile', {
        method: 'POST',
        body: formData
      });
      const result = await response.json();

      if (result.success) {
        alert('MÉ™lumatlar yadda saxlanÄ±ldÄ±!');
        window.location.reload();
      } else {
        alert('XÉ™ta: ' + result.message);
      }
    } catch (err) {
      alert('Sistem xÉ™tasÄ± baÅŸ verdi.');
    }
  });
</script>

{% endblock %}